item" id="nav-insights" onclick="showScreen('insights')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      <span id="nav-i-label">HistoripdateUI();
}
function goObStep(s) {
  document.getElementById(`ob-step-${obStep}`).classList.remove('active');
  obStep=s;
  document.getElementById(`ob-step-${s}`).classList.add('active');
  for(let i=0;i<3;i++) document.getElementById(`dot-${i}`).classList.toggle('done',i<=s);
}
function finishOnboarding() {
  localStorage.setItem('d_onboarded','1');
  updateUI();
  showScreen('journal');
}

/* â”€â”€ JOURNAL â”€â”€ */
function onJournalInput() {
  const txt=document.getElementById('journal-text').value;
  const w=txt.trim()===''?0:txt.trim().split(/\s+/).length;
  set('word-count',t('wordCount')(w));
}
function saveEntry() {
  const txt=document.getElementById('journal-text').value.trim();
  if(!txt){showToast(t('noText'),true);return;}
  S.entries.unshift({id:Date.now().toString(),content:txt,createdAt:new Date().toISOString(),analysis:null});
  localStorage.setItem('d_entries',JSON.stringify(S.entries));
  document.getElementById('journal-text').value=''; onJournalInput();
  showToast(t('saved'));
}

/* â”€â”€ ANALYSE â”€â”€ */
async function analyzeEntry() {
  const txt=document.getElementById('journal-text').value.trim();
  if(txt.length<20){showToast(t('noText'),true);return;}
  const btn=document.getElementById('btn-analyze');
  btn.disabled=true;
  btn.innerHTML=`<div class="spinner"></div><span>${t('analyzing')}</span>`;
  try {
    const res=await fetch('/api/analyze',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text:txt,lang:S.lang}),
    });
    const data=await res.json();
    if(!res.ok) throw new Error(data.error||t('errGeneric'));
    const analysis=data.analysis;
    const entry={id:Date.now().toString(),content:txt,createdAt:new Date().toISOString(),analysis};
    S.entries.unshift(entry); S.lastAnalysis=analysis;
    localStorage.setItem('d_entries',JSON.stringify(S.entries));
    document.getElementById('journal-text').value=''; onJournalInput();
    renderAnalysis(analysis);
    showScreen('analysis');
  } catch(err) {
    const msg=err.message?.includes('fetch')?t('errNetwork'):err.message?.length<100?err.message:t('errGeneric');
    showToast(msg,true);
  } finally {
    btn.disabled=false;
    btn.innerHTML=`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><span id="analyze-label">${t('analyzeBtn')}</span>`;
  }
}

/* â”€â”€ RENDU ANALYSE â”€â”€ */
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function renderAnalysis(a) {
  const d=(i)=>`animation-delay:${i*80}ms`;
  document.getElementById('analysis-content').innerHTML=`
    <div class="analysis-card card-paper" style="${d(0)}">
      <div class="card-label card-label-accent">âœ¦ ${t('moodLabel')}</div>
      <div class="mood-display"><span class="mood-emoji">${esc(a.moodEmoji)}</span><span class="mood-label">${esc(a.mood)}</span></div>
    </div>
    ${a.patterns?.length?`<div class="analysis-card card-paper" style="${d(1)}">
      <div class="card-label">â—ˆ ${t('patternsLabel')}</div>
      <div class="bullet-list">${a.patterns.map(p=>`<div class="bullet-item"><span class="bullet-marker">â€¢</span><span>${esc(p)}</span></div>`).join('')}</div>
    </div>`:''}
    <div class="analysis-card card-lavender" style="${d(2)}">
      <div class="card-label card-label-lavender">â—‡ ${t('questionsLabel')}</div>
      <div class="bullet-list">${(a.deepQuestions||[]).map((q,i)=>`<div class="bullet-item"><span class="bullet-marker bullet-marker-lavender">${i+1}.</span><span>${esc(q)}</span></div>`).join('')}</div>
    </div>
    <div class="analysis-card card-accent" style="${d(3)}">
      <div class="card-label card-label-accent">âœ¿ ${t('reframingLabel')}</div>
      <p class="reframing-text">${esc(a.reframing)}</p>
    </div>
    <div class="analysis-card card-sage" style="${d(4)}">
      <div class="card-label card-label-sage">â–¸ ${t('microLabel')}</div>
      <p class="micro-action-text">${esc(a.microAction)}</p>
    </div>`;
}

/* â”€â”€ HISTORIQUE â”€â”€ */
function renderInsights() {
  const c=document.getElementById('insights-list');
  if(!S.entries.length){
    c.innerHTML=`<div class="empty-state"><span class="empty-icon">ðŸ“”</span><div class="empty-title">${t('emptyTitle')}</div><div class="empty-sub">${t('emptySub')}</div></div>`;
    return;
  }
  const loc=S.lang==='pt'?'pt-BR':S.lang==='en'?'en-US':'fr-FR';
  c.innerHTML=S.entries.map(e=>{
    const d=new Date(e.createdAt).toLocaleDateString(loc,{day:'numeric',month:'short',year:'numeric'});
    const m=e.analysis;
    return `<div class="entry-card"><div class="entry-card-top"><span class="entry-date">${d}</span>${m?`<div class="entry-mood-badge">${esc(m.moodEmoji)} ${esc(m.mood)}</div>`:''}</div><div class="entry-preview">${esc(e.content)}</div></div>`;
  }).join('');
}

/* â”€â”€ PARAMÃˆTRES â”€â”€ */
function changeLang(code){S.lang=code;localStorage.setItem('d_lang',code);updateUI();}
function exportData(){
  const blob=new Blob([JSON.stringify(S.entries,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`diario-ia-${new Date().toISOString().slice(0,10)}.json`;a.click();
  showToast(t('exported'));
}
function confirmDeleteAll(){openModal('modal-delete'
